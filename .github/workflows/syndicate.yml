name: "Syndication"

on:
  workflow_dispatch:
    branches:
      - master
  schedule:
    - cron: '*/15 14 * * *'

jobs:
  syndicate:
    name: "Post Jobs"
    runs-on: ubuntu-latest

    steps:
    - name: "Check out repository"
      uses: actions/checkout@v3

    - uses: ruby/setup-ruby@v1
      with:
        bundler-cache: true

    - run: bundle install

    - name: Get Cached Jobs DB
      id: get-cache-jobsdb
      uses: actions/cache@v3
      with:
        path: ./jobs.sqlite
        key: jobs-cache

    - run: bundle exec ruby main.rb
      env:
        SYN_ENV: production
        TD_SLACK_WEBHOOK: ${{ secrets.TD_SLACK_WEBHOOK }}
        TW_TDJOBS_APIKEY: ${{ secrets.TW_TDJOBS_APIKEY }}
        TW_TDJOBS_APISECRET: ${{ secrets.TW_TDJOBS_APISECRET }}
        TW_TDJOBS_APIBEARER: ${{ secrets.TW_TDJOBS_APIBEARER }}
        TW_TDJOBS_ACTOKEN: ${{ secrets.TW_TDJOBS_ACTOKEN }}
        TW_TDJOBS_ACSECRET: ${{ secrets.TW_TDJOBS_ACSECRET }}
        TW_TDJOBS_CLIENTID: ${{ secrets.TW_TDJOBS_CLIENTID }}
        TW_TDJOBS_CLIENTSECRET: ${{ secrets.TW_TDJOBS_CLIENTSECRET }}

    - name: Clear Jobs DB Cache
      uses: actions/github-script@v6
      with:
        script: |
          console.log("Clearing Jobs Cache")
          github.rest.actions.deleteActionsCacheByKey({
            owner: context.repo.owner,
            repo: context.repo.repo,
            key: "jobs-cache",
          })
          console.log("Jobs Cache Cleared")

    - name: Save Jobs DB
      uses: actions/cache/save@v3
      id: save-cache-jobsdb
      with:
        path: ./jobs.sqlite
        key: jobs-cache